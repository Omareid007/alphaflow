# AI Active Trader - Deployment Pipeline
# Deploys to staging on develop, production on main

name: Deploy

on:
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  determine-environment:
    name: Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - name: Set environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

  deploy:
    name: Deploy to ${{ needs.determine-environment.outputs.environment }}
    runs-on: ubuntu-latest
    needs: determine-environment
    environment: ${{ needs.determine-environment.outputs.environment }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig.yaml
          echo "KUBECONFIG=$(pwd)/kubeconfig.yaml" >> $GITHUB_ENV
      
      - name: Set deployment variables
        run: |
          echo "IMAGE_TAG=${{ github.sha }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${{ needs.determine-environment.outputs.environment }}" >> $GITHUB_ENV
          echo "GITHUB_REPOSITORY=${{ github.repository }}" >> $GITHUB_ENV
      
      - name: Deploy namespace and network policies
        run: kubectl apply -f infrastructure/k8s/namespace.yaml
      
      - name: Deploy secrets and service accounts
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          TOGETHER_API_KEY: ${{ secrets.TOGETHER_API_KEY }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          POLYGON_API_KEY: ${{ secrets.POLYGON_API_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          DOCKER_CONFIG_JSON: ${{ secrets.DOCKER_CONFIG_JSON }}
        run: |
          # Apply service account (no substitution needed)
          kubectl apply -f infrastructure/k8s/common/service-account.yaml
          
          # Substitute and apply secrets
          envsubst < infrastructure/k8s/common/secrets.yaml | kubectl apply -f -
          envsubst < infrastructure/k8s/postgres/secrets.yaml | kubectl apply -f -
      
      - name: Deploy infrastructure (NATS, PostgreSQL)
        run: |
          kubectl apply -f infrastructure/k8s/nats/
          kubectl apply -f infrastructure/k8s/postgres/deployment.yaml
          kubectl apply -f infrastructure/k8s/postgres/service.yaml
      
      - name: Wait for infrastructure
        run: |
          kubectl rollout status statefulset/nats -n ai-trader --timeout=180s || true
          kubectl rollout status statefulset/postgres -n ai-trader --timeout=180s || true
      
      - name: Deploy services
        run: |
          # Apply service manifests with variable substitution
          for service in api-gateway trading-engine ai-decision market-data analytics orchestrator; do
            envsubst < infrastructure/k8s/services/${service}.yaml | kubectl apply -f -
          done
      
      - name: Deploy ingress
        run: kubectl apply -f infrastructure/k8s/ingress.yaml
      
      - name: Wait for rollout
        run: |
          for service in api-gateway trading-engine ai-decision market-data analytics orchestrator; do
            kubectl rollout status deployment/${service} -n ai-trader --timeout=300s
          done
      
      - name: Run smoke tests
        run: |
          # Wait for services to be ready
          sleep 30
          
          # Health check each service
          for port in 5000 3001 3002 3003 3004 3005; do
            curl -f http://ai-trader.internal:${port}/health || exit 1
          done
      
      - name: Notify on success
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Deployment to ${{ needs.determine-environment.outputs.environment }} succeeded",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":white_check_mark: *AI Active Trader* deployed to *${{ needs.determine-environment.outputs.environment }}*\nCommit: `${{ github.sha }}`"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: Notify on failure
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Deployment to ${{ needs.determine-environment.outputs.environment }} failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ":x: *AI Active Trader* deployment to *${{ needs.determine-environment.outputs.environment }}* failed\nCommit: `${{ github.sha }}`"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  rollback:
    name: Rollback (Manual)
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch'
    needs: [determine-environment, deploy]
    environment: ${{ needs.determine-environment.outputs.environment }}
    
    steps:
      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > kubeconfig.yaml
          echo "KUBECONFIG=$(pwd)/kubeconfig.yaml" >> $GITHUB_ENV
      
      - name: Rollback deployments
        run: |
          for service in api-gateway trading-engine ai-decision market-data analytics orchestrator; do
            kubectl rollout undo deployment/${service} -n ai-trader
          done
      
      - name: Wait for rollback
        run: |
          for service in api-gateway trading-engine ai-decision market-data analytics orchestrator; do
            kubectl rollout status deployment/${service} -n ai-trader --timeout=300s
          done
