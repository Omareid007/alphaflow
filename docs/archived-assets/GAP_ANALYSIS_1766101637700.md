# Gap Analysis: Strategy System Implementation

**Date:** December 2024  
**Purpose:** Document gaps between previous implementation and new strict non-hallucination requirements

---

## Executive Summary

The new specification document introduces **strict non-negotiable rules** that invalidate significant portions of the previous `AI_TRADING_STRATEGY_IMPLEMENTATION_MANIFESTO.md`. This document analyzes the gaps and provides a remediation plan.

---

## 1. Critical Rule Violations in Previous Manifesto

### ❌ RULE 1: No Unsourced Performance Numbers

**Previous Manifesto Violations:**
```
"Key Performance Targets:
- Portfolio Sharpe Ratio: >1.2 (validated benchmark: 0.87-1.49 individual strategies)
- Maximum Drawdown: <20%
- Win Rate: >55%
- Expected Annual Return: 12-18% with controlled volatility"
```

**Specific Numbers Found (MUST BE REMOVED):**
| Claim | Location | Issue |
|-------|----------|-------|
| "16.7% CAGR" | Line ~XX | Not computed from code |
| "0.87 Sharpe" | Line ~XX | Not computed from code |
| "Dual Momentum: 16.7% CAGR, 0.87 Sharpe, -17.8% max DD" | Research benchmarks | These are from Antonacci's backtest, not ours |
| "Risk-Managed Momentum: 0.97 Sharpe vs 0.53 unmanaged" | Research benchmarks | Literature values, not our computation |
| "HMM Regime: 36% returns, 1.7 Sharpe" | Research benchmarks | Literature values, not our computation |
| "FinBERT: 97% accuracy" | Research benchmarks | Literature values, not our computation |

**Remediation:** 
- All these numbers MUST be removed from any manifesto/documentation
- They can only be displayed IF computed by our `server/backtests/runner.ts` and stored with `runId` + provenance

### ❌ RULE 2: Strategy Defaults Must Have Provenance

**Previous Manifesto:** Many defaults lacked proper citation or provenance tracking.

**New Requirement:**
```typescript
defaultProvenance: {
  type: 'academic_paper' | 'broker_documentation' | 'computed_walk_forward' | 'conventional_default' | 'user_specified';
  source: string;    // Full citation
  note?: string;     // Rationale
}
```

**Status:** ✅ EXISTING IMPLEMENTATION COMPLIANT
- `shared/strategy-manifest.ts` already has `ParameterSchema` with `defaultProvenance`
- `server/strategies/manifests/*.json` files already include provenance for all parameters

### ❌ RULE 3: Forecasts Must Be Probabilistic

**Previous Manifesto Violations:**
```
"Expected Annual Return: 12-18%"
"3-year forward predictions"
```

**New Requirement:** NO point forecasts. Only:
- Quantile distributions (p10, p25, p50, p75, p90)
- Scenario probabilities (bull/base/bear)
- Fan chart data
- Required disclaimers

**Status:** ✅ EXISTING IMPLEMENTATION COMPLIANT
- `server/forecast/forecast-runner.ts` already produces probabilistic outputs only
- Has required disclaimers citing Goyal & Welch (2008)

### ❌ RULE 4: Backtest Must Include Walk-Forward + Overfitting Metric

**Previous Manifesto:** Did not specify walk-forward separation or overfitting detection.

**New Requirement:**
- Walk-forward: 70% IS / 30% OOS
- Overfitting metric: IS/OOS Sharpe ratio or PBO
- Overfitting-gated allocation

**Status:** ✅ EXISTING IMPLEMENTATION COMPLIANT
- `server/backtests/runner.ts` has walk-forward configuration
- Has `overfittingMetric: 'is_oos_ratio'` and threshold

### ❌ RULE 5: Must Respect Budget/Caching Utilities

**New Requirement:** Use `server/lib/fetchWithBudgetAndCache.ts` and `server/lib/apiBudget.ts`.

**Status:** ⚠️ NOT VERIFIED
- These files referenced in spec but need verification they exist
- All market data fetches should go through these utilities

---

## 2. Architecture Differences

### Previous Manifesto Architecture
```
Microservices Architecture:
- services/api-gateway (port 3000)
- services/trading-engine (port 3001)
- services/ai-decision (port 3002)
- services/market-data (port 3003)
- services/analytics (port 3004)
- services/orchestrator (port 3005)
```

### New Specification Architecture
```
Monolith with Orchestrator Authority:
- server/autonomous/orchestrator.ts (central coordinator)
- server/strategies/manifest-registry.ts
- server/backtests/runner.ts
- server/forecast/forecast-runner.ts
- server/allocation/allocator.ts
- server/routes.ts (single API surface)
```

**Gap:** The previous manifesto described a microservices architecture that doesn't match the repo anchors. The new spec requires all logic to flow through the orchestrator in a more monolithic structure.

**Remediation:** 
- Align documentation to actual repo structure
- New `STRATEGY_MANIFESTO.md` correctly references repo anchors

---

## 3. File-by-File Gap Analysis

### Existing Files (COMPLIANT ✅)

| File | Status | Notes |
|------|--------|-------|
| `shared/strategy-manifest.ts` | ✅ | Has proper Zod schema with provenance |
| `server/strategies/manifest-registry.ts` | ✅ | Loads and validates manifests |
| `server/strategies/manifests/*.json` | ✅ | 3 manifests with full provenance |
| `server/backtests/runner.ts` | ✅ | Walk-forward + costs + overfitting |
| `server/forecast/forecast-runner.ts` | ✅ | Probabilistic only + disclaimers |
| `server/allocation/allocator.ts` | ✅ | Multi-method with constraints |
| `docs/RESEARCH_BENCHMARKS.md` | ✅ | Academic foundations, no unsourced claims |

### Missing/Required Files

| File | Status | Action |
|------|--------|--------|
| `docs/STRATEGY_MANIFESTO.md` | ✅ CREATED | Replaces old manifesto |
| `docs/UI_FLOW_STRATEGIES.md` | ✅ CREATED | Maps UI → API → DB |
| `server/lib/fetchWithBudgetAndCache.ts` | ❓ VERIFY | Check existence |
| `server/lib/apiBudget.ts` | ❓ VERIFY | Check existence |

### Deprecated Files

| File | Status | Action |
|------|--------|--------|
| `/home/claude/AI_TRADING_STRATEGY_IMPLEMENTATION_MANIFESTO.md` | ❌ DEPRECATED | Contains rule violations; do not use |

---

## 4. UI Text Violations

### Text to Remove

| Screen | Text | Reason |
|--------|------|--------|
| Strategy cards | "~15% historical CAGR" | Unsourced |
| Strategy cards | "60% win rate" | Not computed |
| BacktestScreen | "Expected annual return: 12-18%" | Point forecast |
| Various | "AI-powered strategies delivering consistent returns" | Marketing |

### Text to Add

| Screen | Text | Reason |
|--------|------|--------|
| BacktestScreen footer | "Past performance does not guarantee future results." | Required |
| ForecastScreen | "These projections are illustrative scenarios, not predictions." | Required |
| ForecastScreen | "Equity premium prediction is historically unreliable (Goyal & Welch, 2008)." | Required |

---

## 5. API Endpoint Gaps

### Required Endpoints (per spec)

| Endpoint | Status |
|----------|--------|
| `GET /api/strategy-manifests` | ⚠️ Need to verify |
| `GET /api/strategy-manifests/:id` | ⚠️ Need to verify |
| `POST /api/strategy-manifests/:id/backtest` | ⚠️ Need to verify |
| `POST /api/strategy-manifests/:id/forecast` | ⚠️ Need to verify |
| `GET /api/allocator/plan` | ⚠️ Need to verify |
| `GET /api/allocator/plan/:id/explain` | ⚠️ Need to verify |
| `GET /api/orchestrator/flow` | ⚠️ Need to verify |

**Action:** Verify these endpoints exist in `server/routes.ts` or add them.

---

## 6. Database Schema Gaps

### Required Tables

| Table | Status |
|-------|--------|
| `backtest_runs` | ⚠️ Need to verify schema.ts |
| `forecast_runs` | ⚠️ Need to verify schema.ts |
| `allocation_plans` | ⚠️ Need to verify schema.ts |
| `external_api_cache_entries` | ✅ Exists in shared/schema.ts |
| `external_api_usage_counters` | ✅ Exists in shared/schema.ts |

---

## 7. Remediation Checklist

### Immediate Actions (Documentation)

- [x] Create `docs/STRATEGY_MANIFESTO.md` (compliant with new rules)
- [x] Create `docs/UI_FLOW_STRATEGIES.md` (maps UI to backend)
- [ ] Mark old `/home/claude/AI_TRADING_STRATEGY_IMPLEMENTATION_MANIFESTO.md` as DEPRECATED

### Code Verification Actions

- [ ] Verify `server/routes.ts` has required endpoints
- [ ] Verify `server/lib/fetchWithBudgetAndCache.ts` exists
- [ ] Verify `server/lib/apiBudget.ts` exists
- [ ] Verify DB schema has required tables

### UI Actions

- [ ] Update `StrategiesScreen.tsx` to load from API
- [ ] Update `StrategyTypeScreen.tsx` to use manifest data
- [ ] Update `ConfigurationScreen.tsx` with provenance tooltips
- [ ] Update `BacktestScreen.tsx` to show computed metrics only
- [ ] Update `CapitalAllocationScreen.tsx` with explanation modal
- [ ] Add `FlowTimeline.tsx` component

### Testing Actions

- [ ] Unit test: Manifest validation
- [ ] Unit test: Backtest determinism
- [ ] Unit test: Allocator constraints
- [ ] Integration test: Wizard → Backtest → Allocation → Order intent

---

## 8. Key Differences Summary

| Aspect | Previous Manifesto | New Specification |
|--------|-------------------|-------------------|
| Performance claims | Hardcoded numbers | Computed only with provenance |
| Architecture | Microservices (6 ports) | Orchestrator-controlled monolith |
| Forecasting | Point estimates allowed | Probabilistic only |
| Overfitting | Not addressed | Walk-forward + IS/OOS ratio |
| Defaults | Some unsourced | All with provenance |
| UI text | Marketing claims | Computed values only |
| Disclaimers | Minimal | Comprehensive, required |

---

## 9. Conclusion

The existing codebase (`server/strategies/`, `server/backtests/`, `server/forecast/`, `server/allocation/`) is **largely compliant** with the new strict rules. The main issues are:

1. **Documentation:** The old manifesto contains rule violations and must be replaced (DONE)
2. **UI:** Text needs to be updated to remove unsourced claims (TODO)
3. **Verification:** Need to confirm API endpoints and DB schema exist (TODO)

The new `docs/STRATEGY_MANIFESTO.md` and `docs/UI_FLOW_STRATEGIES.md` files provide compliant documentation for the system.

---

*This gap analysis ensures alignment between specification and implementation.*
