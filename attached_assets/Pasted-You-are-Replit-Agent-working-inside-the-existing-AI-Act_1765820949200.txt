You are Replit Agent working inside the existing AI Active Trader repo.

GOAL (Task #1): Make Alpaca Paper Trading the SINGLE source of truth for orders/positions/trade history, and make every UI status (pending/success/skipped/etc.) map to a real decision→order→fill lifecycle. Remove/disable any mock/demo flows in production paths. No hallucinated completion: every claimed change must be verifiable by running commands and showing actual outputs.

NON-NEGOTIABLE RULES:
- Do NOT add mock data, fake trades, or placeholder statuses.
- If a feature depends on external connectivity (Alpaca), it must fail gracefully with a real error message and a clear “missing config” state — not fake data.
- Every change must include: (1) code change, (2) a quick verification command run + output snippet, and (3) docs update in /docs.

STEP 0 — READ FIRST (do not code yet)
1) Open and read these docs files and summarize what they claim (short, factual):
   - docs/INDEX.md
   - docs/ARCHITECTURE.md
   - docs/TRADING_SAGA_SEQUENCES.md
   - docs/ORCHESTRATOR_AND_AGENT_RUNTIME.md
   - docs/API_REFERENCE.md
   - docs/TESTING.md
   - docs/API_BUDGETING_AND_CACHING.md
2) Inspect these code areas and list what each currently does (paths only + 1-2 lines):
   - server/trading/alpaca-trading-engine.ts
   - server/trading/paper-trading-engine.ts
   - server/autonomous/orchestrator.ts
   - server/routes.ts (trade/decision endpoints)
   - shared/schema.ts (trades, positions, ai_decisions)
   - client/screens/AnalyticsScreen.tsx
   - client/screens/AISuggestedTradesScreen.tsx
   - client/components/ActivityFlowWidget.tsx

STEP 1 — DEFINE THE “SOURCE OF TRUTH CONTRACT”
Create a short internal spec (as a comment in code + a doc update) that defines:
- Decision States: proposed → approved (optional) → submitted_to_broker → partially_filled → filled → canceled/rejected → closed
- Order Source: Alpaca order id is canonical.
- Position Source: Alpaca positions are canonical.
- DB Role: DB stores decision metadata, reasoning, and links to broker order ids + status snapshots for UI speed/history.

STEP 2 — SCHEMA FIX (minimal but correct)
Update the DB schema so internal records can represent real broker reality:
- Add to trades OR create a new table (choose minimal change):
  - broker (text) default “alpaca”
  - brokerOrderId (text, indexed)
  - brokerStatus (text)
  - submittedAt, filledAt, canceledAt (timestamps nullable)
  - rejectReason / cancelReason (text nullable)
- Ensure ai_decisions includes a stable link to brokerOrderId OR to a trade row that contains it.
- Create and run a migration (drizzle) and confirm it applied successfully.

STEP 3 — STOP MIXING ENGINES IN UI PATHS
A) Trade Ledger:
- Replace Analytics “Trade Ledger” source so it reflects Alpaca order history (or a unified endpoint that returns broker-derived ledger items).
- Implement a new endpoint if needed:
  GET /api/ledger?source=alpaca&limit=...
  returning normalized items:
  { id, symbol, side, qty, submittedAt, filledAt, avgFillPrice, status, brokerOrderId, strategyId?, decisionId? }

B) AI Suggested Trades:
- Ensure AISuggestedTradesScreen lists ONLY real decision records that are:
  - proposed/approved and NOT yet submitted, OR
  - submitted and waiting fill
- Remove any “pending_execution” list that is generated from ephemeral in-memory maps without a persisted decision/order link.
- Every item must show:
  - decisionId
  - action, confidence, reasoning (already exists)
  - AND either “Not submitted yet” OR the real Alpaca brokerOrderId + broker status.

STEP 4 — REAL ORDER SYNC (so statuses are meaningful)
Implement a polling sync job (server-side) that:
- Pulls Alpaca open orders + recent closed orders on an interval (respect rate limits).
- Updates DB snapshots (trade rows / decision rows) so UI reflects truth.
- Also syncs positions from Alpaca for the Auto Trading screen.

STEP 5 — EXECUTE PATH MUST BE REAL
When user taps “Execute / Activate / Close / Emergency Stop”:
- The action must call Alpaca (paper) and return the real order response.
- Persist brokerOrderId immediately.
- Update ai_decisions.status to submitted_to_broker and transition based on sync updates.

STEP 6 — VERIFICATION (MUST RUN AND SHOW OUTPUT)
Add a smoke test script (or documented manual steps) that proves:
1) With Alpaca paper keys present:
   - GET /api/alpaca/account returns real values
   - GET /api/ledger?source=alpaca returns non-mock orders
   - AISuggestedTradesScreen does NOT show fake pending_execution items
2) Without Alpaca keys:
   - endpoints return “missing config” errors (no fake data)

Run and paste output for:
- server start
- one curl call to /api/ledger?source=alpaca (or equivalent)
- one curl call to /api/ai-decisions/history showing real statuses

STEP 7 — DOCS UPDATE (required)
Update these docs so they match the code you actually changed:
- docs/API_REFERENCE.md (new endpoints / changed payloads)
- docs/TRADING_SAGA_SEQUENCES.md (state machine + status mapping)
- docs/APP_OVERVIEW.md (what is source of truth now)
- docs/TESTING.md (smoke test steps)
If any doc claims something not implemented, fix the doc instead of pretending.

DELIVERABLE FORMAT:
- A short checklist of completed items
- Files changed list
- Commands run + outputs
- Links/paths to updated docs
