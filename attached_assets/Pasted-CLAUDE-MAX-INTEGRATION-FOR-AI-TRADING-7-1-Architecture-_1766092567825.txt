CLAUDE MAX INTEGRATION FOR AI TRADING
7.1 Architecture for Claude Max Integration
Goal: Use your Claude Max subscription for all AI processing and trading decisions.

Integration Approach:

┌─────────────────────────────────────────────────────────────┐
│                      YOUR CLAUDE MAX ACCOUNT                │
│              (claude.ai - Max subscription)                 │
└─────────────────────────────────────────────────────────────┘
                              ▲
                              │ Authenticated API calls
                              │
┌─────────────────────────────────────────────────────────────┐
│                    CLAUDE INTEGRATION LAYER                  │
│                  server/ai/claude-client.ts                  │
│                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │ Session Mgr │  │ Rate Limiter│  │ Request Queue       │ │
│  │ (OAuth/API) │  │ (Respect    │  │ (Priority-based)    │ │
│  │             │  │  Max limits)│  │                     │ │
│  └─────────────┘  └─────────────┘  └─────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      LLM GATEWAY                            │
│           (Routes to Claude Max as PRIMARY)                 │
└─────────────────────────────────────────────────────────────┘
7.2 Claude Client Implementation
// NEW FILE: server/ai/claude-client.ts

import Anthropic from '@anthropic-ai/sdk';

interface ClaudeConfig {
  apiKey: string;                    // From environment or user config
  model: 'claude-sonnet-4-20250514' | 'claude-opus-4-20250514';
  maxTokens: number;
  rateLimit: {
    requestsPerMinute: number;
    tokensPerMinute: number;
  };
}

class ClaudeClient {
  private client: Anthropic;
  private requestQueue: PriorityQueue<ClaudeRequest>;
  private rateLimiter: RateLimiter;

  constructor(config: ClaudeConfig) {
    this.client = new Anthropic({
      apiKey: config.apiKey,
    });
    this.rateLimiter = new RateLimiter(config.rateLimit);
  }

  async analyzeTradeOpportunity(params: {
    symbol: string;
    marketData: MarketData;
    technicals: TechnicalIndicators;
    news: NewsArticle[];
    sentiment: SentimentData;
    portfolio: PortfolioState;
    riskLimits: RiskLimits;
  }): Promise<TradeDecision> {
    const prompt = this.buildTradeAnalysisPrompt(params);

    const response = await this.rateLimiter.execute(() =>
      this.client.messages.create({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 2000,
        system: TRADING_SYSTEM_PROMPT,
        messages: [{ role: 'user', content: prompt }],
      })
    );

    return this.parseTradeDecision(response);
  }

  async evaluateRisk(decision: TradeDecision, portfolio: PortfolioState): Promise<RiskAssessment> {
    // Risk evaluation using Claude
  }

  async generateExitStrategy(position: Position, marketConditions: MarketConditions): Promise<ExitStrategy> {
    // Exit strategy generation
  }

  private buildTradeAnalysisPrompt(params: TradeAnalysisParams): string {
    return `
## Trading Analysis Request

### Symbol: ${params.symbol}

### Current Market Data
- Price: $${params.marketData.price}
- Change: ${params.marketData.changePercent}%
- Volume: ${params.marketData.volume}
- VWAP: $${params.marketData.vwap}

### Technical Indicators
- RSI(14): ${params.technicals.rsi14}
- MACD: ${params.technicals.macd} (Signal: ${params.technicals.macdSignal})
- SMA(20): $${params.technicals.sma20}
- SMA(50): $${params.technicals.sma50}
- ATR(14): $${params.technicals.atr14}

### Recent News Sentiment
${params.news.map(n => `- ${n.title} (Sentiment: ${n.sentiment})`).join('\n')}

### Portfolio Context
- Cash Available: $${params.portfolio.cash}
- Current Positions: ${params.portfolio.positionCount}
- Total Exposure: ${params.portfolio.exposurePercent}%
- Daily P&L: ${params.portfolio.dailyPnl}%

### Risk Limits
- Max Position Size: ${params.riskLimits.maxPositionSizePercent}%
- Max Total Exposure: ${params.riskLimits.maxTotalExposurePercent}%
- Daily Loss Limit: ${params.riskLimits.dailyLossLimitPercent}%

### Task
Analyze this trading opportunity and provide:
1. Action recommendation (BUY / SELL / HOLD)
2. Confidence level (0-100)
3. Suggested position size (% of portfolio)
4. Entry price target
5. Stop loss price
6. Take profit price
7. Reasoning for the decision
8. Key risks to monitor

Respond in JSON format.
`;
  }
}

// System prompt for trading decisions
const TRADING_SYSTEM_PROMPT = `You are an expert quantitative trading analyst. Your role is to analyze market data, technical indicators, and news sentiment to make informed trading decisions.

Key principles:
1. Risk management is paramount - never recommend positions that exceed risk limits
2. Consider multiple timeframes and confirm trends before entry
3. Set realistic stop losses based on volatility (ATR)
4. Factor in news sentiment but don't overreact to single events
5. Be conservative with confidence levels - only high conviction trades should exceed 70%

Always respond with structured JSON containing your analysis and recommendations.`;

export const claudeClient = new ClaudeClient({
  apiKey: process.env.CLAUDE_API_KEY!,
  model: 'claude-sonnet-4-20250514',
  maxTokens: 4000,
  rateLimit: {
    requestsPerMinute: 50,  // Adjust based on Max tier
    tokensPerMinute: 100000,
  },
});
7.3 Authentication Flow for Claude Max
Option 1: API Key (Recommended)

// User provides API key in admin settings
// Stored encrypted in admin_settings table

// server/routes/admin.ts
app.post('/api/admin/claude-config', async (req, res) => {
  const { apiKey } = req.body;

  // Validate key by making test call
  const isValid = await validateClaudeApiKey(apiKey);
  if (!isValid) {
    return res.status(400).json({ error: 'Invalid API key' });
  }

  // Store encrypted
  await storage.setAdminSetting('claude_api_key', encrypt(apiKey), true);

  res.json({ success: true });
});
Option 2: OAuth Flow (If Anthropic supports)

// Future: OAuth integration if Anthropic provides
// Currently not available - use API key approach