You are working inside the existing “AI Active Trader” Replit project (Valyu already integrated).
Goal: replace naive “Valyu 1 call/week” with a retrieval-budget system + caching, and document it.

DO THIS IN ORDER (no hallucinations; read the repo first):

1) READ & MAP THE CURRENT STATE
- Scan /docs first, then scan the codebase for: “valyu”, “deepsearch”, “deepresearch”, “VALYU_API_KEY”.
- Identify the current Valyu call sites, current caching (if any), and current config patterns for API keys.
- Output a short “current state” summary in your response as comments in the PR/commit message.

2) IMPLEMENT PROVIDER BUDGETS (starting with Valyu)
Create a new provider-agnostic budget module:
- Add /src/server/budgets/ with:
  - BudgetStore (persistent; use existing DB if present; else sqlite file in /data)
  - BudgetPolicy (per-provider limits + reset periods)
  - BudgetEnforcer (checks BEFORE calling provider; records usage AFTER responses)

3) VALYU-SPECIFIC BUDGETING (RETRIEVAL-BASED)
Valyu is priced per retrieval (not per request). Implement:
- usage_unit = “retrieval_count” where retrieval_count = response.results.length (or results_by_source summed if available).
- Add default monthly budgets (configurable):
  - valyu.web_retrievals_per_month = 2000
  - valyu.finance_retrievals_per_month = 500
  - valyu.proprietary_retrievals_per_month = 100
- Also enforce concurrency guard: max 5 QPS per API key (queue requests).

4) VALYU CALL OPTIMIZATION & SAFETY
At every Valyu call site:
- Add caching layer with deterministic cache keys.
- Add “query shaping” helper that enforces:
  - time range constraints in the query text (e.g., “last 30 days” for news)
  - start_date/end_date params when supported
  - relevance_threshold default (reasonable value; configurable)
  - max_num_results default small (e.g., 5) and increases only when needed
  - included_sources/excluded_sources controls to avoid accidentally hitting proprietary sources unless explicitly requested
- Add max_price caps appropriate to the chosen source tier to prevent surprise spend; if partial response (206-like semantics), degrade gracefully and log.

5) DOCS UPDATE (MANDATORY)
Update /docs in the most relevant file(s):
- Add a new section: “API Budgets & Caching”
- Explain:
  - Why Valyu is retrieval-budgeted
  - The default monthly budgets
  - Where budgets are configured
  - Cache TTL rules
  - What logs/metrics are emitted
  - How to change limits safely

6) UI REFLECTION (ONLY FOR THIS SECTION)
Add a small UI panel (or extend existing settings page):
- “Provider Budgets” card listing current usage vs monthly limits for Valyu (web/finance/proprietary)
- Show: used, remaining, reset date, and last-call timestamp.
No redesign beyond this in this step.

7) TESTS
Add minimal tests:
- Budget blocks calls when exhausted
- Cache hits do not consume budget
- Budget counters persist across restarts

Deliverables:
- Code changes + docs changes committed
- A short changelog entry in /docs describing this exact enhancement
