Database Enrichment Plan
Phase 1: Symbol Universe Enrichment (from Alpaca)
-- Enhance broker_assets table
ALTER TABLE broker_assets ADD COLUMN IF NOT EXISTS
  sector VARCHAR(100),
  industry VARCHAR(200),
  market_cap DECIMAL(20,2),
  pe_ratio DECIMAL(10,2),
  dividend_yield DECIMAL(6,4),
  beta DECIMAL(6,4),
  avg_volume BIGINT,
  week_52_high DECIMAL(12,4),
  week_52_low DECIMAL(12,4),
  last_enriched_at TIMESTAMP,
  enrichment_source VARCHAR(50);

-- Create index for efficient queries
CREATE INDEX IF NOT EXISTS idx_broker_assets_sector ON broker_assets(sector);
CREATE INDEX IF NOT EXISTS idx_broker_assets_market_cap ON broker_assets(market_cap);
Enrichment Script (run daily):

// server/jobs/enrich-universe.ts
async function enrichUniverseFromAlpaca() {
  const assets = await alpaca.getAssets({ status: 'active' });

  for (const asset of assets) {
    // 1. Get fundamentals from FMP (free tier)
    const fundamentals = await fmp.getCompanyProfile(asset.symbol);

    // 2. Get technical data from Alpaca
    const bars = await alpaca.getBars(asset.symbol, { timeframe: '1Day', limit: 252 });

    // 3. Calculate metrics
    const metrics = {
      avg_volume: calculateAvgVolume(bars),
      week_52_high: Math.max(...bars.map(b => b.high)),
      week_52_low: Math.min(...bars.map(b => b.low)),
      beta: calculateBeta(bars, spyBars),
    };

    // 4. Upsert to database
    await db.upsertBrokerAsset({
      symbol: asset.symbol,
      ...fundamentals,
      ...metrics,
      last_enriched_at: new Date(),
      enrichment_source: 'alpaca+fmp'
    });
  }
}
Phase 2: Fundamentals Enrichment
Data Sources (Priority Order):

SEC EDGAR (FREE, official) - 10-K, 10-Q filings
FMP (FREE tier, 250/day) - Financial ratios
Wikidata (FREE, unlimited) - Company metadata
FRED (FREE, unlimited) - Macro indicators
-- Enhanced universe_fundamentals table
CREATE TABLE IF NOT EXISTS universe_fundamentals_enhanced (
  symbol VARCHAR(20) PRIMARY KEY,
  -- Income Statement
  revenue DECIMAL(20,2),
  gross_profit DECIMAL(20,2),
  operating_income DECIMAL(20,2),
  net_income DECIMAL(20,2),
  eps DECIMAL(10,4),
  -- Balance Sheet
  total_assets DECIMAL(20,2),
  total_liabilities DECIMAL(20,2),
  total_equity DECIMAL(20,2),
  cash_and_equivalents DECIMAL(20,2),
  total_debt DECIMAL(20,2),
  -- Ratios
  pe_ratio DECIMAL(10,2),
  pb_ratio DECIMAL(10,2),
  ps_ratio DECIMAL(10,2),
  debt_to_equity DECIMAL(10,4),
  current_ratio DECIMAL(10,4),
  roe DECIMAL(10,4),
  roa DECIMAL(10,4),
  -- Growth
  revenue_growth_yoy DECIMAL(10,4),
  eps_growth_yoy DECIMAL(10,4),
  -- Metadata
  fiscal_year_end VARCHAR(10),
  last_filing_date DATE,
  source VARCHAR(50),
  updated_at TIMESTAMP DEFAULT NOW()
);
Phase 3: Technical Indicators Enrichment
-- Technical indicators table (updated daily)
CREATE TABLE IF NOT EXISTS universe_technicals (
  symbol VARCHAR(20),
  date DATE,
  -- Price Action
  open DECIMAL(12,4),
  high DECIMAL(12,4),
  low DECIMAL(12,4),
  close DECIMAL(12,4),
  volume BIGINT,
  vwap DECIMAL(12,4),
  -- Moving Averages
  sma_20 DECIMAL(12,4),
  sma_50 DECIMAL(12,4),
  sma_200 DECIMAL(12,4),
  ema_12 DECIMAL(12,4),
  ema_26 DECIMAL(12,4),
  -- Momentum
  rsi_14 DECIMAL(6,2),
  macd DECIMAL(12,6),
  macd_signal DECIMAL(12,6),
  macd_histogram DECIMAL(12,6),
  -- Volatility
  atr_14 DECIMAL(12,4),
  bollinger_upper DECIMAL(12,4),
  bollinger_lower DECIMAL(12,4),
  -- Trend
  adx_14 DECIMAL(6,2),
  plus_di DECIMAL(6,2),
  minus_di DECIMAL(6,2),
  -- Support/Resistance
  pivot_point DECIMAL(12,4),
  resistance_1 DECIMAL(12,4),
  support_1 DECIMAL(12,4),
  PRIMARY KEY (symbol, date)
);

CREATE INDEX idx_technicals_symbol_date ON universe_technicals(symbol, date DESC);
Phase 4: Macro Economic Data
-- Macro indicators table (from FRED)
CREATE TABLE IF NOT EXISTS macro_indicators (
  indicator_id VARCHAR(50) PRIMARY KEY,
  name VARCHAR(200),
  category VARCHAR(100),
  latest_value DECIMAL(20,6),
  previous_value DECIMAL(20,6),
  change_percent DECIMAL(10,4),
  frequency VARCHAR(20),
  last_updated DATE,
  source VARCHAR(50) DEFAULT 'FRED'
);

-- Pre-populate key indicators
INSERT INTO macro_indicators (indicator_id, name, category, frequency) VALUES
  ('DGS10', '10-Year Treasury Yield', 'interest_rates', 'daily'),
  ('DGS2', '2-Year Treasury Yield', 'interest_rates', 'daily'),
  ('FEDFUNDS', 'Federal Funds Rate', 'interest_rates', 'monthly'),
  ('CPIAUCSL', 'Consumer Price Index', 'inflation', 'monthly'),
  ('UNRATE', 'Unemployment Rate', 'employment', 'monthly'),
  ('GDP', 'Gross Domestic Product', 'gdp', 'quarterly'),
  ('VIXCLS', 'VIX Volatility Index', 'volatility', 'daily'),
  ('DCOILWTICO', 'WTI Crude Oil Price', 'commodities', 'daily');
4.3 Data Labeling & Categorization
Asset Classification System:

// server/services/asset-classifier.ts

enum AssetClass {
  LARGE_CAP_GROWTH = 'large_cap_growth',
  LARGE_CAP_VALUE = 'large_cap_value',
  MID_CAP_GROWTH = 'mid_cap_growth',
  MID_CAP_VALUE = 'mid_cap_value',
  SMALL_CAP = 'small_cap',
  CRYPTO_MAJOR = 'crypto_major',
  CRYPTO_ALT = 'crypto_alt',
  ETF_INDEX = 'etf_index',
  ETF_SECTOR = 'etf_sector',
}

interface AssetLabels {
  symbol: string;
  assetClass: AssetClass;
  sector: string;           // Technology, Healthcare, etc.
  industry: string;         // Software, Biotech, etc.
  marketCapTier: 'mega' | 'large' | 'mid' | 'small' | 'micro';
  liquidityTier: 'high' | 'medium' | 'low';
  volatilityTier: 'high' | 'medium' | 'low';
  trendStrength: 'strong_up' | 'weak_up' | 'neutral' | 'weak_down' | 'strong_down';
  momentumScore: number;    // -100 to +100
  valueScore: number;       // -100 to +100
  qualityScore: number;     // 0 to 100
}

function classifyAsset(symbol: string, data: EnrichedAssetData): AssetLabels {
  return {
    symbol,
    assetClass: determineAssetClass(data),
    sector: data.sector,
    industry: data.industry,
    marketCapTier: categorizeMarketCap(data.market_cap),
    liquidityTier: categorizeLiquidity(data.avg_volume),
    volatilityTier: categorizeVolatility(data.atr_14, data.close),
    trendStrength: calculateTrendStrength(data),
    momentumScore: calculateMomentumScore(data),
    valueScore: calculateValueScore(data),
    qualityScore: calculateQualityScore(data),
  };
}