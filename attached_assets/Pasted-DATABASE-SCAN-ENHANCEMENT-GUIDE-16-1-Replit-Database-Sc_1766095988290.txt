DATABASE SCAN & ENHANCEMENT GUIDE
16.1 Replit Database Scan Prompt
TASK: Scan database and identify enhancement opportunities

STEPS:
1. Query current table schemas:
   SELECT table_name, column_name, data_type
   FROM information_schema.columns
   WHERE table_schema = 'public';

2. Check row counts per table:
   SELECT schemaname, relname, n_live_tup
   FROM pg_stat_user_tables;

3. Identify missing data:
   - broker_assets without fundamentals
   - Symbols without technical indicators
   - Gaps in historical price data

4. Generate enhancement report with:
   - Tables needing new columns
   - Missing indexes
   - Data quality issues
   - Coverage gaps
16.2 Database Enhancement SQL
-- Phase 1: Enhance broker_assets
ALTER TABLE broker_assets ADD COLUMN IF NOT EXISTS
  sector VARCHAR(100),
  industry VARCHAR(200),
  market_cap DECIMAL(20,2),
  pe_ratio DECIMAL(10,2),
  dividend_yield DECIMAL(6,4),
  beta DECIMAL(6,4),
  avg_volume BIGINT,
  week_52_high DECIMAL(12,4),
  week_52_low DECIMAL(12,4),
  last_enriched_at TIMESTAMP,
  enrichment_source VARCHAR(50);

-- Phase 2: Create technical indicators table
CREATE TABLE IF NOT EXISTS universe_technicals (
  symbol VARCHAR(20),
  date DATE,
  open DECIMAL(12,4),
  high DECIMAL(12,4),
  low DECIMAL(12,4),
  close DECIMAL(12,4),
  volume BIGINT,
  sma_20 DECIMAL(12,4),
  sma_50 DECIMAL(12,4),
  sma_200 DECIMAL(12,4),
  rsi_14 DECIMAL(6,2),
  macd DECIMAL(12,6),
  macd_signal DECIMAL(12,6),
  atr_14 DECIMAL(12,4),
  bollinger_upper DECIMAL(12,4),
  bollinger_lower DECIMAL(12,4),
  PRIMARY KEY (symbol, date)
);

-- Phase 3: Create vector embeddings table
CREATE TABLE IF NOT EXISTS pattern_embeddings (
  id SERIAL PRIMARY KEY,
  symbol VARCHAR(20),
  date DATE,
  embedding vector(1536),  -- Using pgvector
  pattern_type VARCHAR(50),
  subsequent_return_5d DECIMAL(6,4),
  subsequent_return_10d DECIMAL(6,4),
  subsequent_return_20d DECIMAL(6,4),
  created_at TIMESTAMP DEFAULT NOW()
);

-- Create indexes
CREATE INDEX idx_technicals_symbol_date ON universe_technicals(symbol, date DESC);
CREATE INDEX idx_embeddings_symbol ON pattern_embeddings(symbol);
CREATE INDEX idx_embeddings_vector ON pattern_embeddings USING ivfflat (embedding vector_cosine_ops);
16.3 Real Data Enrichment Jobs
Job 1: Alpaca Asset Universe

// server/jobs/enrich-from-alpaca.ts

async function enrichFromAlpaca() {
  const alpaca = getAlpacaClient();
  const assets = await alpaca.getAssets({ status: 'active', asset_class: 'us_equity' });

  for (const asset of assets) {
    // Fetch 1 year of daily bars
    const bars = await alpaca.getBarsV2(asset.symbol, {
      start: subYears(new Date(), 1).toISOString(),
      end: new Date().toISOString(),
      timeframe: '1Day',
    });

    const barsArray = [];
    for await (const bar of bars) {
      barsArray.push(bar);
    }

    if (barsArray.length > 0) {
      // Calculate metrics
      const avgVolume = barsArray.reduce((sum, b) => sum + b.v, 0) / barsArray.length;
      const week52High = Math.max(...barsArray.map(b => b.h));
      const week52Low = Math.min(...barsArray.map(b => b.l));

      // Update database
      await db.query(`
        UPDATE broker_assets SET
          avg_volume = $1,
          week_52_high = $2,
          week_52_low = $3,
          last_enriched_at = NOW(),
          enrichment_source = 'alpaca'
        WHERE symbol = $4
      `, [avgVolume, week52High, week52Low, asset.symbol]);
    }
  }
}
Job 2: Fundamentals from FMP (Free Tier)

// server/jobs/enrich-fundamentals.ts

async function enrichFundamentals() {
  const symbols = await db.query('SELECT symbol FROM broker_assets WHERE sector IS NULL LIMIT 250');

  for (const { symbol } of symbols.rows) {
    try {
      const profile = await fmp.getCompanyProfile(symbol);

      if (profile) {
        await db.query(`
          UPDATE broker_assets SET
            sector = $1,
            industry = $2,
            market_cap = $3,
            pe_ratio = $4,
            dividend_yield = $5,
            beta = $6,
            enrichment_source = COALESCE(enrichment_source || '+fmp', 'fmp')
          WHERE symbol = $7
        `, [
          profile.sector,
          profile.industry,
          profile.mktCap,
          profile.pe,
          profile.lastDiv / profile.price,
          profile.beta,
          symbol
        ]);
      }
    } catch (e) {
      console.log(`FMP quota or error for ${symbol}`);
    }

    // Respect rate limits: 250/day free tier
    await sleep(350); // ~250 requests in ~90 seconds
  }
}
Job 3: Technical Indicators

// server/jobs/calculate-technicals.ts

import { SMA, RSI, MACD, ATR, BollingerBands } from 'technicalindicators';

async function calculateTechnicals() {
  const symbols = await db.query('SELECT DISTINCT symbol FROM broker_assets WHERE tradable = true');

  for (const { symbol } of symbols.rows) {
    const bars = await getHistoricalBars(symbol, 250); // 1 year

    if (bars.length < 200) continue;

    const closes = bars.map(b => b.close);
    const highs = bars.map(b => b.high);
    const lows = bars.map(b => b.low);
    const volumes = bars.map(b => b.volume);

    // Calculate indicators
    const sma20 = SMA.calculate({ period: 20, values: closes });
    const sma50 = SMA.calculate({ period: 50, values: closes });
    const sma200 = SMA.calculate({ period: 200, values: closes });
    const rsi = RSI.calculate({ period: 14, values: closes });
    const macd = MACD.calculate({
      values: closes,
      fastPeriod: 12,
      slowPeriod: 26,
      signalPeriod: 9
    });
    const atr = ATR.calculate({ period: 14, high: highs, low: lows, close: closes });
    const bb = BollingerBands.calculate({ period: 20, stdDev: 2, values: closes });

    // Store latest values
    const latestIdx = bars.length - 1;
    await db.query(`
      INSERT INTO universe_technicals (
        symbol, date, open, high, low, close, volume,
        sma_20, sma_50, sma_200, rsi_14, macd, macd_signal,
        atr_14, bollinger_upper, bollinger_lower
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16)
      ON CONFLICT (symbol, date) DO UPDATE SET
        sma_20 = EXCLUDED.sma_20,
        rsi_14 = EXCLUDED.rsi_14
    `, [
      symbol, bars[latestIdx].date,
      bars[latestIdx].open, bars[latestIdx].high,
      bars[latestIdx].low, bars[latestIdx].close,
      bars[latestIdx].volume,
      sma20[sma20.length - 1],
      sma50[sma50.length - 1],
      sma200[sma200.length - 1],
      rsi[rsi.length - 1],
      macd[macd.length - 1]?.MACD,
      macd[macd.length - 1]?.signal,
      atr[atr.length - 1],
      bb[bb.length - 1]?.upper,
      bb[bb.length - 1]?.lower
    ]);
  }
}
Job 4: Macro Indicators from FRED

// server/jobs/sync-fred.ts

const FRED_SERIES = [
  { id: 'DGS10', name: '10-Year Treasury Yield' },
  { id: 'DGS2', name: '2-Year Treasury Yield' },
  { id: 'FEDFUNDS', name: 'Federal Funds Rate' },
  { id: 'CPIAUCSL', name: 'Consumer Price Index' },
  { id: 'UNRATE', name: 'Unemployment Rate' },
  { id: 'VIXCLS', name: 'VIX Volatility Index' },
];

async function syncFRED() {
  for (const series of FRED_SERIES) {
    const data = await fred.getSeries(series.id);
    const latest = data.observations[data.observations.length - 1];
    const previous = data.observations[data.observations.length - 2];

    await db.query(`
      INSERT INTO macro_indicators (indicator_id, name, latest_value, previous_value, last_updated)
      VALUES ($1, $2, $3, $4, $5)
      ON CONFLICT (indicator_id) DO UPDATE SET
        latest_value = EXCLUDED.latest_value,
        previous_value = EXCLUDED.previous_value,
        last_updated = EXCLUDED.last_updated
    `, [series.id, series.name, latest.value, previous.value, latest.date]);
  }
}
16.4 Scheduling Jobs
// server/jobs/scheduler.ts
import cron from 'node-cron';

// Run daily at 6 AM UTC
cron.schedule('0 6 * * *', async () => {
  await enrichFromAlpaca();
  await enrichFundamentals();
  await syncFRED();
});

// Run after market close (9 PM UTC = 4 PM ET)
cron.schedule('0 21 * * 1-5', async () => {
  await calculateTechnicals();
});

// Weekly pattern embedding generation
cron.schedule('0 0 * * 0', async () => {
  await generatePatternEmbeddings();
});
