Before doing anything, open and strictly follow:
- docs/AGENT_EXECUTION_GUIDE.md
- docs/APP_OVERVIEW.md

ROLE
Act as:
- Software Architect
- Process / Engineering Manager
- Full-Stack Engineer
- Technical Writer / Documentation Specialist

OVERALL GOAL
Evolve our governance system by:
1) Extending docs/AGENT_EXECUTION_GUIDE.md at the end (APPEND ONLY, DO NOT REMOVE OR REWRITE EXISTING SECTIONS).
2) Introducing a new document: docs/LESSONS_LEARNED.md for Continuous Calibration and Continuous Development.
3) Adding guidance at the end of docs/AGENT_EXECUTION_GUIDE.md so you can:
   - Analyse each incoming task,
   - Decide which “mode” to operate in (bugfix, feature, refactor, infra, UX, meta/continuous-improvement, etc.),
   - Optionally use lessons learned from past tasks to work smarter.

You MUST:
- Keep ALL existing content in docs/AGENT_EXECUTION_GUIDE.md intact.
- Only APPEND new sections at the end of the file (you may add headings 11, 12, etc., but do not remove or rewrite prior sections).
- Create / update docs/LESSONS_LEARNED.md to support this process.

--------------------------------
STEP 1 – Create / Update docs/LESSONS_LEARNED.md
--------------------------------

1. If docs/LESSONS_LEARNED.md does not exist:
   - Create it with a clear structure that supports **continuous improvement**:
     - Purpose & how it relates to AGENT_EXECUTION_GUIDE.md.
     - How and when the agent should update it.
     - Sections to capture learnings from each task.

2. Use a structure like this (you can refine, but keep the intent):

   - `# Lessons Learned`

   - **1. Purpose & Relationship to AGENT_EXECUTION_GUIDE**
     - Explain that this document is an **optional, supplementary guideline**:
       - The agent MUST always read `docs/AGENT_EXECUTION_GUIDE.md` first.
       - AFTER that, the agent MAY read `docs/LESSONS_LEARNED.md` to apply any relevant insights.
     - Clarify that this file captures practical lessons from previous tasks, to make future work smarter, safer, and more efficient.

   - **2. How to Use This Document**
     - When starting a new task:
       1. Read AGENT_EXECUTION_GUIDE.
       2. Optionally scan LESSONS_LEARNED for sections relevant to the task type (bugfix, metrics, infra, etc.).
       3. Apply any applicable insight (patterns/anti-patterns, testing reminder, prompt tips).

   - **3. Continuous Calibration & Continuous Development Process**
     - Define that, after each **significant task** (bugfix, feature, major refactor, infra change, etc.), the agent SHOULD:
       - Reflect briefly:
         - What worked well?
         - What went wrong or was painful?
         - What would we do differently next time?
       - Append a new “lesson entry” to this doc.

     - Each lesson entry can use a template like:
       - Task label / short description
       - Date/time (if available)
       - Context / area (e.g. P&L metrics, orchestrator, UI, infra)
       - What worked well (patterns to repeat)
       - Issues / pitfalls (patterns to avoid)
       - Improvements for next time (e.g. “always add regression tests before refactoring X”, “clarify metric definition first”, “call FINANCIAL_METRICS.md before touching P&L”)

   - **4. Categorised Lessons**
     - Subsections such as:
       - 4.1 Prompting & Task Definition Lessons
       - 4.2 Architecture & Design Lessons
       - 4.3 Implementation & Code Quality Lessons
       - 4.4 Testing & QA Lessons
       - 4.5 DevOps / Infra Lessons
       - 4.6 Domain-Specific Lessons (e.g. trading / P&L specifics)
     - Each subsection can list bullet-point lessons with short explanations.

   - **5. Improvement Backlog**
     - A table or list that tracks ideas for future improvements derived from lessons, e.g.:
       - “Add more tests around orchestrator error-handling”
       - “Standardise metric naming between backend and UI”

   - **6. Change Log**
     - Simple log of major changes to the lessons document.

3. If docs/LESSONS_LEARNED.md already exists:
   - DO NOT delete useful content.
   - Integrate it into the structure above (merge, reorganise, but keep meaning).
   - Ensure it clearly states it is **secondary** to AGENT_EXECUTION_GUIDE (i.e. read AGENT_EXECUTION_GUIDE first).

--------------------------------
STEP 2 – Append “Continuous Calibration & Lessons Learned” Section to AGENT_EXECUTION_GUIDE.md
--------------------------------

Now extend docs/AGENT_EXECUTION_GUIDE.md **by APPENDING new content at the end**. Do NOT remove or rewrite existing sections.

Add a new top-level section near the end, e.g.:

`## 11. Continuous Calibration & Lessons Learned`

Content guidelines:

1. **Purpose**
   - Explain that this section introduces a **continuous improvement loop**.
   - The goal is to steadily improve:
     - Code quality,
     - Testing practices,
     - Prompt patterns,
     - Architectural decisions,
     - And overall agent behaviour over time.

2. **When to Use**
   - State that this is primarily used:
     - After completing a significant task (bugfix, feature, refactor, infra change).
     - When the user explicitly asks for retrospectives / process improvements.
   - It is NOT mandatory for every tiny change, but recommended for:
     - Any change touching critical flows (P&L, orders, orchestrator, auth).
     - Any complex or multi-step feature.

3. **Process**
   - After finishing a significant task (implementation + tests + docs):
     - The agent SHOULD:
       1. Reflect on the task execution:
          - What worked well?
          - Where did the agent struggle or waste time/tokens?
          - Any misunderstandings from the prompt?
          - Any missing tests or docs discovered late?
       2. Summarise key **lessons learned** as 3–7 bullet points.
       3. Update `docs/LESSONS_LEARNED.md`:
          - Add a new entry under a relevant category.
          - Use a small template, similar to:
            - Task name / short label
            - Area (metrics, orchestrator, UI, infra, etc.)
            - What worked
            - What to improve
            - Actionable recommendations for future tasks.
       4. If lessons imply changes to AGENT_EXECUTION_GUIDE, suggest them but DO NOT change the guide automatically unless the user explicitly asks for governance updates.

4. **How to Use Lessons in Future Tasks**
   - Add explicit instructions such as:
     - “When starting any new significant task:
        1) Read AGENT_EXECUTION_GUIDE.md.
        2) Optionally read docs/LESSONS_LEARNED.md and look for relevant patterns.
        3) Apply any useful lesson, especially around:
           - Testing strategy,
           - Handling of financial metrics,
           - Interaction with external APIs,
           - Prompt interpretation and scope control.”

5. **Relationship to Testing & Documentation**
   - Note that Continuous Calibration is NOT a substitute for tests or docs, but an extra layer:
     - Tests prove correctness.
     - Docs explain how the system works.
     - Lessons Learned explain how to work on the system better next time.

--------------------------------
STEP 3 – Append “Task Analysis & Mode Selection” Section to AGENT_EXECUTION_GUIDE.md
--------------------------------

Next, append ANOTHER top-level section, e.g.:

`## 12. Task Analysis & Mode Selection`

This section gives the agent a **standard way to analyse each new task and decide which “mode” to operate in**.

Content guidelines:

1. **Purpose**
   - Explain that before acting, the agent SHOULD:
     - Analyse the user’s request,
     - Classify the task,
     - Select an appropriate “mode” that dictates:
       - Primary roles,
       - Docs to consult,
       - Typical workflow.

2. **Task Types / Modes**
   - Define a small set of canonical modes (you can adjust wording, but include the idea):

     - **Bugfix Mode**
       - Triggered by: words like “bug”, “broken”, “incorrect”, “wrong P&L”, “error”, etc.
       - Focus:
         - Identify root cause.
         - Fix with minimal change.
         - Add regression tests.
         - Update docs where logic or behaviour changed.
       - Typical roles: Product Analyst, Architect, Full-Stack, QA.

     - **Feature Mode (New Feature / Enhancement)**
       - Triggered by: “add”, “implement new”, “new widget”, “new endpoint”, etc.
       - Focus:
         - Clarify feature value and acceptance criteria.
         - Design minimal coherent solution.
         - Implement end-to-end with tests and docs.
       - Typical roles: PM, Architect, Full-Stack, QA, UX.

     - **Refactor Mode**
       - Triggered by: “clean up”, “refactor”, “modularise”, “extract service”, etc.
       - Focus:
         - Preserve external behaviour.
         - Improve structure/readability/testability.
         - Add tests if missing.
       - Typical roles: Architect, Full-Stack, QA.

     - **Infra / DevOps Mode**
       - Triggered by: “scripts”, “build”, “deployment”, “Docker”, “Replit run command”, etc.
       - Focus:
         - Improve run/test/deploy experience.
         - Avoid destructive operations.
         - Update runtime / deployment docs.
       - Typical roles: DevOps, Architect, QA.

     - **UI / UX Mode**
       - Triggered by: “design”, “layout”, “widget arrangement”, “labels”, “user confusion”, etc.
       - Focus:
         - Improve clarity and usability.
         - Keep functional behaviour intact unless specified.
         - Document major UX decisions if relevant.
       - Typical roles: PM, UX, Frontend, QA.

     - **Meta / Continuous Improvement Mode**
       - Triggered by: “update guide”, “change process”, “improve prompts”, “lessons learned”, etc.
       - Focus:
         - Evolve governance, docs, and internal processes.
         - Never change business logic without explicit request.
       - Typical roles: Engineering Manager, Architect, Technical Writer.

3. **Mode Selection Procedure**
   - Instruct the agent that for each new task:
     1. Read the user’s prompt.
     2. Decide which primary mode(s) apply (sometimes more than one).
     3. State the chosen mode(s) briefly at the beginning of its internal plan (and optionally in the response).
     4. Apply the relevant workflow from the guide:
        - For Bugfix Mode: emphasise regression tests, root cause, docs.
        - For Feature Mode: emphasise requirements, design, tests, docs.
        - For Refactor Mode: emphasise preserving behaviour and tests.
        - etc.

4. **Docs to Consult by Mode**
   - For each mode, suggest key docs:

     - Bugfix Mode:
       - AGENT_EXECUTION_GUIDE.md
       - APP_OVERVIEW.md
       - ARCHITECTURE.md
       - TESTING.md
       - (FINANCIAL_METRICS.md if metrics-related)
       - (LESSONS_LEARNED.md optionally)

     - Feature Mode:
       - APP_OVERVIEW.md (features and flows)
       - ARCHITECTURE.md (impacts)
       - TESTING.md (coverage expectations)
       - FINANCIAL_METRICS.md (if metric-related)
       - LESSONS_LEARNED.md (patterns/pitfalls)

     - Refactor Mode:
       - ARCHITECTURE.md
       - TESTING.md
       - LESSONS_LEARNED.md for previous refactor lessons.

     - Infra / DevOps Mode:
       - APP_OVERVIEW.md (Runtime & Deployment section)
       - Any DEPLOYMENT/RUN docs
       - TESTING.md (test commands)
       - LESSONS_LEARNED.md for infra lessons.

     - UI / UX Mode:
       - APP_OVERVIEW.md (features/screens)
       - Any design docs (if exist)
       - FINANCIAL_METRICS.md if metrics presentation changes.

     - Meta / Continuous Improvement Mode:
       - AGENT_EXECUTION_GUIDE.md
       - LESSONS_LEARNED.md

5. **Token / Efficiency Reminder**
   - Reinforce that Mode Selection is also used to minimise token/credits:
     - By quickly choosing the right subset of files and docs to consult.
     - By avoiding scanning unrelated parts of the codebase.

--------------------------------
STEP 4 – Safety & Scope
--------------------------------

- Do NOT remove or rewrite any existing sections of docs/AGENT_EXECUTION_GUIDE.md.
- Only append new sections at the end, as described above.
- Do NOT introduce destructive operations or changes to runtime behaviour as part of this meta/governance update.
- You may create or update docs/LESSONS_LEARNED.md, but avoid touching other code or config unless strictly necessary.

--------------------------------
STEP 5 – Final Response
--------------------------------

When you are done, respond with:

1. A brief summary of:
   - Changes made to docs/AGENT_EXECUTION_GUIDE.md (section names only).
   - Structure and content of docs/LESSONS_LEARNED.md.
2. The exact list of files created/modified.
3. Any suggestions for future improvements to the continuous improvement / mode selection system (optional).
`
