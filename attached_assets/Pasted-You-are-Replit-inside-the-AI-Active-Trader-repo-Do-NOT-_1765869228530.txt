You are Replit inside the AI Active Trader repo.

Do NOT create a new admin area. The WordPress-inspired Admin page already exists.
Your job is to add an “Observability” section to the SAME Admin Hub and make it fully functional end-to-end:
UI buttons → backend endpoints → DB/broker reality → UI updates (no placeholders).

Hard Rules:
- No hallucinations: “Done” must be proven by UI interactions + curl examples + screenshots/notes.
- No mock data in observability views.
- traceId MUST be the primary correlation key across: orchestrator cycles, work queue items, LLM calls, decisions, orders, fills.
- External telemetry export must be optional and safe if not configured.

========================================================
STEP 0 — DISCOVERY (MANDATORY FIRST)
========================================================
0.1 Read docs/OBSERVABILITY.md and current admin docs. If docs are missing, create them.
0.2 Locate the Admin Hub (WordPress-style) entry screen/component and the module system (if any).
0.3 Inventory what already exists:
- any logger wrapper
- any traceId propagation code
- work queue schema + dead-letter fields/logic
- LLM gateway logging
Output a short “Reality Snapshot”:
- what telemetry exists now (likely logs only)
- what endpoints exist for queue/llm/orchestrator visibility
- what UI is already showing vs what is missing

Only then implement the steps below.

========================================================
STEP 1 — OPEN TELEMETRY (TRACES + METRICS) FOR NODE SERVER
========================================================
Implement OpenTelemetry in a minimal, production-safe way using the official approach:
- SDK initialization early before app boot
- Auto-instrumentation for HTTP/Express
- Manual spans for orchestrator cycles, work items, and LLM calls
(Use OTel JS SDK + instrumentation model.) 

1.1 Add dependencies:
- @opentelemetry/sdk-node
- @opentelemetry/auto-instrumentations-node
- @opentelemetry/exporter-trace-otlp-http
- @opentelemetry/exporter-metrics-otlp-http
- @opentelemetry/resources
- @opentelemetry/semantic-conventions
- (optional) @opentelemetry/instrumentation-express

Use the official Node “getting started” patterns and exporter guidance. (No custom reinvented tracing.) 

1.2 Create server/observability/otel.ts:
- Initialize NodeSDK with autoInstrumentations
- Configure OTLP HTTP exporters by env:
  - OTEL_EXPORTER_OTLP_ENDPOINT (e.g., http://localhost:4318)
  - OTEL_SERVICE_NAME=ai-active-trader
- Default fallback: if no OTLP endpoint, use console exporters (dev only)
- Add resource attributes: service.name, service.version, deployment.environment
- Ensure trace context propagation across async boundaries

1.3 Ensure traceId correlation:
- When your app has an internal traceId (cyc-*, batch-*, run-*), attach it as a span attribute: aiat.trace_id
- Also include decisionId/orderId/workItemId as span attributes when present
- Any log line should include: traceId + otel traceId (if available)

========================================================
STEP 2 — INSTRUMENT THE REAL HOT PATHS
========================================================
2.1 Orchestrator cycle span:
- Start span name: orchestrator.cycle
- Attributes: cycleId(traceId), strategyCount, symbolsCount
- Record events for each stage: market fetch, signal ingest, decision, order planning, execution dispatch

2.2 Work queue processing span:
- Start span name: workqueue.process
- Attributes: workItemId, workType, attempt, traceId
- Record events: claimed, started, external_call, retry_scheduled, dead_lettered, completed
- Capture duration + error status

2.3 LLM calls span:
- Start span name: llm.call
- Attributes: provider(openai/openrouter), model, role, traceId, latency, token/cost estimates (if available)
- Record success/failure and attach minimal safe metadata (no secrets)

========================================================
STEP 3 — METRICS: QUEUE, ERRORS, COSTS, LATENCY
========================================================
Add real metrics (OTel metrics + DB-derived counters):
- Gauge: workqueue.pending_count
- Gauge: workqueue.dead_letter_count
- Histogram: workqueue.processing_latency_ms
- Counter: workqueue.retries_total
- Counter: llm.calls_total (by provider/model/role)
- Histogram: llm.latency_ms
- Counter: external_api.calls_total (by provider)
- Gauge: external_api.budget_remaining (by provider if tracked)

Provide a backend endpoint:
GET /api/admin/observability/metrics/summary
Returns:
- latest values + fetchedAt + source(db/otel/computed)

========================================================
STEP 4 — ADMIN HUB “OBSERVABILITY” SECTION (SINGLE ADMIN PAGE)
========================================================
Add one new sidebar menu item in the existing Admin Hub: “Observability”.

Inside it, implement 4 tabs (all functional):

TAB A) Health Overview
- queue depth, dead letters, oldest pending age
- orchestrator last run / next run
- LLM calls last 1h/24h (counts, error rate)
All data from real endpoints.

TAB B) Work Queue Console (including Dead Letters)
- table filters: status (pending/running/succeeded/failed/dead), type, traceId, time range
- row detail drawer: payload, attempts, lastError, timestamps
- actions (with confirmations):
  - Retry (requeue) a dead letter
  - Cancel a pending item
  - Force-dead-letter (admin only)
Each button must call a real API and then refresh.

TAB C) Trace Explorer (traceId-first UX)
- search box: traceId
- results show:
  - decisions linked to traceId
  - work items linked to traceId
  - llm calls linked to traceId
  - orders/fills if implemented; otherwise show “G4 pending: orders/fills lifecycle not yet implemented”
- Provide a “Copy trace bundle” button that exports JSON of the joined data for debugging.

TAB D) Alerts & Rules
- show configured alert rules and their current status
- allow admin to toggle alerts on/off and set thresholds
- allow defining at least:
  - dead_letter_count > N
  - retry_rate > X/min
  - orchestrator silent for > M minutes
  - LLM error rate > Y%
  - provider budget exhausted
- alert delivery:
  - Webhook URL (generic)
  - (optional) Sentry integration toggle
Do not claim Slack/Telegram unless you implement it.

========================================================
STEP 5 — BACKEND ADMIN ENDPOINTS (REAL)
========================================================
Implement server/admin/observability routes:

GET /api/admin/observability/health
- returns all Health Overview fields with source metadata

GET /api/admin/work-queue/items?status=&type=&traceId=&limit=
GET /api/admin/work-queue/items/:id
POST /api/admin/work-queue/items/:id/retry
POST /api/admin/work-queue/items/:id/cancel
POST /api/admin/work-queue/items/:id/dead-letter

GET /api/admin/observability/trace/:traceId
- returns joined view:
  decisions, llm_calls, work_items, trades/orders/fills as available
- if orders/fills tables don’t exist yet, omit them and return a “missingModules” array.

Alerts:
GET /api/admin/alerts/rules
POST /api/admin/alerts/rules
POST /api/admin/alerts/rules/:id/toggle
POST /api/admin/alerts/test

Implement alert evaluation job:
- Runs every 30–60 seconds
- Uses DB/metrics summary endpoints
- On trigger: sends webhook POST with a structured payload
- Records alert events to DB table alert_events (for audit + UI)

========================================================
STEP 6 — OPTIONAL: OTEL COLLECTOR DOCKER COMPOSE (LOCAL/OPS GUIDE)
========================================================
Add a minimal /ops/observability/docker-compose.yml that runs:
- otel-collector
- grafana
- tempo
- loki
(Only if repository already has ops folder; otherwise create /ops.)

Write docs/OBSERVABILITY.md:
- How to enable OTEL_EXPORTER_OTLP_ENDPOINT
- How to run the collector stack locally
- How to confirm traces/metrics arrive
- Common troubleshooting notes

Note: Loki ingestion via OTel Collector should use OTLP HTTP / otlphttp exporter approach.

========================================================
STEP 7 — PROOF OF WORK (MANDATORY)
========================================================
Deliver:
1) git diff --stat
2) UI walkthrough list (AdminHub → Observability → tabs)
3) 10 curl examples proving:
   - health
   - list queue items
   - item details
   - retry dead letter
   - trace lookup
   - list alert rules
   - create rule
   - trigger test alert
4) Show that a retry changes DB state and UI updates accordingly.
5) Confirm no secrets are logged or returned.

Do not proceed to new features. Finish this P1 completely and verifiably.
