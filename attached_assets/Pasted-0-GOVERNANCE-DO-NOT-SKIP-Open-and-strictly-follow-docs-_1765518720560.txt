0. GOVERNANCE (DO NOT SKIP)

Open and strictly follow docs/AGENT_EXECUTION_GUIDE.md as the primary governance document for this repo.

When the guide instructs you to consult other docs (docs/APP_OVERVIEW.md, docs/ARCHITECTURE.md, docs/ORCHESTRATOR_AND_AGENT_RUNTIME.md, docs/AI_MODELS_AND_PROVIDERS.md, docs/CONNECTORS_AND_INTEGRATIONS.md, docs/FINANCIAL_METRICS.md, docs/TESTING.md, docs/OBSERVABILITY.md, docs/LESSONS_LEARNED.md), open and follow those sections before writing or modifying any code.

Never ignore or bypass constraints, safety rules, or workflows defined in these docs.

Do not modify orchestrator safety systems.

Do not bypass Data Fusion Engine rules.

Do not introduce LLM usage into execution logic.

You must complete the entire task within the architectural, safety, and workflow constraints defined in the documentation.

1. TASK SUMMARY

Goal: Add an Adaptive Risk Mode to the Moving Average Crossover (7/20) strategy.
This mode automatically shifts between "conservative", "balanced", "aggressive" presets based on market intelligence from the Data Fusion Engine.

Critical rule:
When adaptiveRiskEnabled = false, the strategy must behave 100% identically to the current production behaviour. No regressions permitted.

2. BACKEND CHANGES
2.1 Extend MovingAverageCrossoverConfig

In the moving-average strategy module, extend the config type/interface:

basePresetId?: "conservative" | "balanced" | "aggressive";
adaptiveRiskEnabled?: boolean;
adaptiveRiskIntervalMinutes?: number;
lastAdaptiveUpdateAt?: string | null;
currentPresetId?: "conservative" | "balanced" | "aggressive";


Update the config normalization function (e.g., normalizeMovingAverageConfig):

Default basePresetId = "balanced"

Default adaptiveRiskEnabled = false

Default adaptiveRiskIntervalMinutes = 15

Default currentPresetId = basePresetId

Default lastAdaptiveUpdateAt = null

Preserve backward compatibility with existing configs.

2.2 Add Deterministic Preset Selector

In moving-average-crossover.ts, create:

export function choosePresetFromMarket(
  intelligence: MarketIntelligenceScore,
  basePresetId: "conservative" | "balanced" | "aggressive"
): "conservative" | "balanced" | "aggressive"


Use only numeric [-1,1] fields: overall, volatility, sentiment, momentum.

Rules:

→ Shift toward conservative when stressed:

If any:

overall <= -0.2

volatility <= -0.4

sentiment <= -0.3

Then step one level more conservative.

→ Shift toward aggressive when strong & calm:

If all:

overall >= 0.6

momentum >= 0.4

volatility >= 0.3

sentiment >= 0

Then step one level more aggressive.

→ Otherwise:

Move one step toward basePresetId.

Thresholds must be stored in a small local constant object.

No AI or LLM usage inside this function.

2.3 Create Adaptive Risk Service

Create:
server/services/adaptive-risk-service.ts

export async function updateStrategyRiskIfNeeded(
  config: MovingAverageCrossoverConfig
): Promise<MovingAverageCrossoverConfig>


Rules:

If adaptiveRiskEnabled !== true → return unchanged.

If lastAdaptiveUpdateAt is within adaptiveRiskIntervalMinutes → return unchanged.

Fetch intelligence via Data Fusion Engine using existing connectors.

If dataQuality === "poor" or activeSources < 2 → force preset = basePresetId.

Compute newPresetId = choosePresetFromMarket(...).

If preset changed:

Copy new values from MOVING_AVERAGE_PRESETS[newPresetId]:

fastPeriod

slowPeriod

allocationPct

riskLimitPct

Update currentPresetId and lastAdaptiveUpdateAt.

Return updated config.

No DB writes inside this function.

2.4 Inject Into Execution & Backtest

In both:

Strategy execution path (signal generation)

Backtesting endpoint

Before SMA calculation:

config = await updateStrategyRiskIfNeeded(config);


Zero behavioural changes if feature disabled.

2.5 Update API Schema & Persistence

Modify moving-average strategy schema (Zod or equivalent):

Add new fields above.

Keep defaults aligned with normalization logic.

In strategy create/update routes:

Accept all new fields.

For new strategies:
currentPresetId = basePresetId

For updates:

Do not overwrite currentPresetId unless adaptive mode is off.

Preserve unrelated strategy fields.

3. FRONTEND CHANGES (React Native)
3.1 Strategy Wizard

Add section:

Adaptive Risk Mode (Market Intelligence)

Toggle → adaptiveRiskEnabled

If ON:

Dropdown: adaptiveRiskIntervalMinutes (5/10/15/30/60)

Base Preset (non-editable): derives from user’s existing preset selection

On submit, include:

adaptiveRiskEnabled

adaptiveRiskIntervalMinutes

basePresetId

currentPresetId = basePresetId (new strategy)

Respect existing UI styling & component patterns.

3.2 Strategy Details Screen

Show:

When OFF:

Risk Mode: Fixed — Balanced


When ON:

Risk Mode: Adaptive — Currently: Aggressive (Base: Balanced)


Add ability to edit adaptive mode and interval.

No raw timestamps shown.

4. CONSTRAINTS (NON-NEGOTIABLE)

Do not modify:

Orchestrator kill switches

Risk ceilings

Data Fusion Engine core logic

Listener Context scoring

Any AI/LLM logic pathway

Global trade-execution rules

Do not rename, restructure, or replace:

Strategy directory structure

Existing React Native components beyond insertion points

Existing preset values

Existing API paths

Do not delete existing logic unless explicitly required to insert adaptive hook.

All code must pass TypeScript checks.

All code must compile in the Expo frontend.

All code must compile in the server build.

5. REPLIT MUST DELIVER

Updated backend config types + normalization.

New deterministic preset selector.

New adaptive-risk service file.

Updated execution & backtest integrations.

Updated schema + API persistence logic.

Updated frontend wizard + details screen UI.

All diffs as patches, not full rewrites.

Build success on server + mobile app.